name: Deploy
on:
  workflow_run:
    workflows: ["Build"]
    types:
      - completed
  workflow_dispatch:
concurrency:
  group: deploy-${{ github.sha }}
  cancel-in-progress: false
jobs:
  deploy-RestCountries:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.event == 'push' &&
       startsWith(github.event.workflow_run.head_branch, 'refs/tags/v'))
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: | 
            8.0.x
            9.0.x
            10.0.x
      
      - name: Restore dependencies
        run: dotnet restore src/RestCountries/RestCountries.csproj
      
      - name: Build RestCountries
        run: dotnet build src/RestCountries/RestCountries.csproj -c Release --no-restore
      
      - name: Pack RestCountries
        run: dotnet pack src/RestCountries/RestCountries.csproj -c Release --no-build -o ./artifacts
      
      - name: Push RestCountries
        run: dotnet nuget push ./artifacts/RestCountries.*.nupkg --source https://api.nuget.org/v3/index.json --skip-duplicate
      
      - name: Wait for NuGet indexing
        run: sleep 120

  deploy-RestCountries-Data:
    needs: deploy-RestCountries
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.event == 'push' &&
       startsWith(github.event.workflow_run.head_branch, 'refs/tags/v'))
    
    steps:
      - name: Wait for NuGet indexing
        run: sleep 120
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: | 
            8.0.x
            9.0.x
            10.0.x
      
      - name: Restore dependencies
        run: dotnet restore src/RestCountries.Data/RestCountries.Data.csproj
      
      - name: Build RestCountries.Data
        run: dotnet build src/RestCountries.Data/RestCountries.Data.csproj -c Release --no-restore
      
      - name: Pack RestCountries.Data
        run: dotnet pack src/RestCountries.Data/RestCountries.Data.csproj -c Release --no-build -o ./artifacts
      
      - name: Push RestCountries.Data
        run: dotnet nuget push ./artifacts/RestCountries.Data.*.nupkg --source https://api.nuget.org/v3/index.json --skip-duplicate
      
  deploy-RestCountries-Embedded:
    needs: deploy-RestCountries
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && 
       github.event.workflow_run.conclusion == 'success' && 
       github.event.workflow_run.event == 'push' &&
       startsWith(github.event.workflow_run.head_branch, 'refs/tags/v'))
    
    steps:
      - name: Wait for NuGet indexing
        run: sleep 120
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: | 
            8.0.x
            9.0.x
            10.0.x
      
      - name: Restore dependencies
        run: dotnet restore src/RestCountries.Embedded/RestCountries.Embedded.csproj
      
      - name: Build RestCountries.Embedded
        run: dotnet build src/RestCountries.Embedded/RestCountries.Embedded.csproj -c Release --no-restore
      
      - name: Pack RestCountries.Embedded
        run: dotnet pack src/RestCountries.Embedded/RestCountries.Embedded.csproj -c Release --no-build -o ./artifacts
      
      - name: Push RestCountries.Embedded
        run: dotnet nuget push ./artifacts/RestCountries.Embedded.*.nupkg --source https://api.nuget.org/v3/index.json --skip-duplicate
      
  create-github-release:
      needs: [deploy-RestCountries, deploy-RestCountries-Data, deploy-RestCountries-Embedded]
      runs-on: ubuntu-latest
      permissions:
        contents: write
      if: |
        github.event_name == 'workflow_dispatch' ||
        (github.event_name == 'workflow_run' && 
         github.event.workflow_run.conclusion == 'success' && 
         github.event.workflow_run.event == 'push' &&
         startsWith(github.event.workflow_run.head_branch, 'refs/tags/v'))
    
      steps:
        - uses: actions/checkout@v4
        - uses: actions/setup-dotnet@v4
          with:
            dotnet-version: | 
              8.0.x
              9.0.x
              10.0.x
      
        - name: Pack all packages
          run: |
            dotnet pack src/RestCountries/RestCountries.csproj -c Release -o ./release-artifacts
            dotnet pack src/RestCountries.Data/RestCountries.Data.csproj -c Release -o ./release-artifacts
            dotnet pack src/RestCountries.Embedded/RestCountries.Embedded.csproj -c Release -o ./release-artifacts
      
        - name: Create GitHub Release
          uses: softprops/action-gh-release@v1
          with:
            files: ./release-artifacts/*.nupkg
            tag_name: ${{ github.event.workflow_run.head_branch }}
            generate_release_notes: true